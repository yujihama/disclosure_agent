# 開示資料 比較・分析ツール 仕様書

## 実装ステータス

このドキュメントは、開示資料比較・分析ツールの機能仕様を定義しています。

**現在の実装状況:**
- ✅ **機能1（書類アップロード）**: 完了
- ✅ **機能2（構造化・分析）**: 完了
- ✅ **機能3（比較エンジン）**: 完了
- 🚧 **機能4（レポート表示）**: 部分実装（基本表示は完了、高度なUI機能は開発中）
- 📋 **機能5（品質・運用）**: 計画中

詳細な実装進捗は `openspec/changes/add-disclosure-comparison-tool/tasks.md` を参照してください。

---

## 1. コンセプト

企業の各種開示資料（有価証券報告書、統合報告書、決算短信、計算書類など）を複数アップロードし、AIを活用して記載内容の「**整合性検証**」と「**差分分析**」を自動で行うツール。

これにより、以下を実現する：
- 開示情報の品質向上
- 作成工数の削減
- 競合他社分析の高度化

---

## 2. 主な機能

### 機能1：書類アップロードと事前処理機能

複数の開示資料をインプットとして受け付ける機能。

#### マルチファイルアップロード
- 比較したい資料を**複数（2つ以上）同時にアップロード**できるUI
- **ドラッグ&ドロップ**対応
- **対応ファイル形式**：
  - PDF（テキストベース、画像ベース両対応）

#### 書類種の自動判定
- アップロードされたファイル名、冒頭20ページ程度を画像でLLMに渡し、書類の種類を自動判定
  - 判定例：「有価証券報告書」「統合報告書」「決算短信」など
- **手動修正機能**：判定結果が誤っていた場合、ユーザーが手動で修正できるインターフェースを提供

---

### 機能2：内容の構造化・分析機能

アップロードされた非構造データ（PDF）を、比較可能な構造化データに変換する**本ツールのコア機能**。

#### 多段階抽出パイプライン
1. **テキスト抽出**（PyMuPDF）
   - PDFからテキストベースで高速抽出
   - ページ単位でテキスト、文字数、画像有無を取得

2. **テーブル抽出**（pdfplumber）
   - 表データを構造化形式（ヘッダー、行データ）で抽出
   - 財務諸表や数値データの比較に活用

3. **Vision抽出**（OpenAI Vision API）
   - スキャンPDFや画像ベースPDFのフォールバック処理
   - テキスト抽出に失敗した場合のみ実行

#### テンプレートに基づくセクション検出
- **事前テンプレート保持**：
  - 書類の種類ごとに標準的な目次構成や記載項目をテンプレートとして保持
  - 例：有価証券報告書の場合
    - 「事業の状況」
    - 「事業等のリスク」
    - 「経営者による財政状態、経営成績及びキャッシュ・フローの状況の分析（MD&A）」
    - など

- **自動セクションマッピング**：
  - LLMに20ページごとのバッチで処理し、各項目が本文の何ページから何ページに記載されているかをマッピング
  - 前回バッチの検出結果を引き継ぎ、ページ跨ぎセクションに対応
  - 検出結果は信頼度スコア付きで保存

**処理性能:**
- 234ページの有価証券報告書を約5秒で処理
- テキスト約30万文字、130個のテーブルを抽出

---

### 機能3：比較・照合エンジン

構造化された書類データをもとに、自動で比較分析を実行する機能。

#### 会社・年度メタデータの自動抽出
- LLMを活用して各書類から会社名と対象年度を自動抽出
- 手動オーバーライドAPIで修正可能

#### 比較モードの自動選択

##### 整合性チェックモード
- **起動条件**：同じ会社の異なる種類の資料がアップされた場合
- **例**：有価証券報告書 vs 統合報告書
- **分析内容**：同一の財務数値や事業説明が整合しているか検証

##### 差分分析モード
- **起動条件**：以下のいずれかの場合
  - 異なる会社の同じ種類の資料（例：A社有報 vs B社有報）
  - 同じ会社の過年度資料（例：2024年有報 vs 2025年有報）
- **分析内容**：記載内容の変化や違いを詳細に分析

##### 多資料比較
- **起動条件**：3つ以上の資料がアップされた場合
- **処理内容**：全資料間での整合性や共通点・相違点を網羅的にチェック

#### セクションマッピングと対応付け
- 比較対象の資料間で、対応するセクションを自動で紐付ける
- テンプレートベースのマッピングと信頼度スコア付与
- **例**：A社有報の「事業等のリスク」とB社有報の「事業等のリスク」

#### LLMベースの統合的差分分析

各マッピングされたセクションに対して、以下を自動実行：

##### 数値データの比較
- 財務諸表などの表中の数値を比較し、不一致箇所を抽出
- 単位の正規化（百万円、千円など）
- 許容誤差の考慮（丸め誤差など）
- 異常値の重要度判定

##### テキストデータの比較

###### 文面差異の検出
- 文章や単語レベルでの追加・削除・変更を検出
- 文字数や記述量の変化を定量化

###### 意味・トーンの分析
- 表現は異なるが、意味的に同じ内容かを判定
- リスク記述などのトーンの強弱を分析
- **例**：
  - 「サイバーセキュリティへの脅威」
  - 「不正アクセスによる情報漏洩リスク」
  - → 意味的に類似、トーンの違いを検出

###### トピック・テーマの比較
- 各セクションで語られている主要なトピックを抽出
  - 例：「脱炭素」「DX」「人材育成」など
- トピックの新規追加・削除・記述量の変化を可視化

###### 重要度の判定
- 各差分が実務的にどの程度重要かをLLMが判定
- 重要度レベル（高・中・低）とその理由を出力

**分析出力:**
- セクション別の詳細差分レポート（構造化データ）
- 差分サマリー（件数、重要度分布）
- 各差分の重要度、理由、推奨アクション

---

### 機能4：結果表示・レポート機能

分析結果をユーザーが直感的に理解できる形式で提示する機能。

#### 実装状況
- ✅ **基本表示**: 比較結果の基本的な表示機能は実装済み
- 🚧 **高度なUI**: 以下の機能は開発中

#### 比較結果サマリー（実装済み）
- 比較モード、ステータス、進捗の表示
- セクション別の差分件数
- 重要度レベル別の集計

#### セクション別詳細表示（実装済み）
- マッピングされた各セクションの差分詳細を表示
- 差分内容、重要度、推奨アクションを構造化表示
- 折りたたみ可能なセクションで長文レポートにも対応

#### サイド・バイ・サイド（左右対照）ビュー（開発中）
- 2つのドキュメントを画面の左右に並べて表示
- **ハイライト表示**：
  - 差異がある箇所や整合性が取れていない箇所をハイライト
  - クリックすると該当ページにジャンプ
- **視覚的な紐付け**：
  - 対応する項目同士が線で結ばれるなど、視覚的な分かりやすさを追求

#### 差分リスト・フィルタ機能（開発中）
- 検出された差分を一覧でリスト表示
- フィルタ（重要度、セクション種別）
- ソート（重要度順、セクション順）
- キーワード検索
- **ドリルダウン機能**：
  - リストから、原文の該当箇所にジャンプ

#### レポート出力（開発中）
- 分析結果をエクスポート可能
- **対応形式**：PDF、Excel
- **レポート内容**：
  - 指摘事項のサマリー
  - セクション別詳細差分
  - 原文の該当箇所のスナップショット
  - ページ番号

---

## 3. UI/UX（ユーザーインターフェース/エクスペリエンス）

### 直感的な操作
- 専門知識がない経理やIR担当者でも簡単に使える、シンプルでクリーンなデザイン

### インタラクティブな分析
- 結果画面で気になる箇所をクリックすると、関連情報がポップアップ
- ユーザーが深掘り分析しやすい設計

### カスタマイズ性
- 比較の際に重視する項目を設定可能
  - **例**：「リスク情報」は特に厳しくチェックする
- 無視する軽微な差異をユーザーが設定できる機能

---

## 4. 技術スタック

### フロントエンド
- **Next.js 14+** / React 18+ / TypeScript 5+
- **Tailwind CSS** + **shadcn/ui**（UIコンポーネント）
- レスポンシブデザイン対応
- ドラッグ&ドロップによるファイルアップロード
- リアルタイムステータスポーリング

### バックエンド
- **Python 3.11+** / **FastAPI**（Webフレームワーク）
- **Celery** + **Redis**（非同期タスク処理、キュー管理）
- PDF解析エンジン：
  - **PyMuPDF**（テキスト抽出）
  - **pdfplumber**（テーブル抽出）
  - **pdf2image** + **Poppler**（画像変換）
- LLM統合（**OpenAI gpt-5**）：
  - 書類種別の自動判定
  - セクション検出とマッピング
  - 会社・年度メタデータ抽出
  - テキスト・意味・トーン分析
  - 重要度判定

### データ処理
- 非構造データの構造化パイプライン
- バックグラウンド処理とステータス管理
- 自動クリーンアップ（24時間保持ポリシー）
- 数値データの単位正規化と比較ロジック

### インフラ
- **Docker** & **Docker Compose**
- PostgreSQL（将来的なデータ永続化用）

---

## 5. 期待される効果

### 開示情報の品質向上
- 複数資料間の整合性を自動チェックし、不整合を早期発見
- ヒューマンエラーの削減
- AIによる重要度判定で優先度付けを支援

### 作成工数の削減
- 手動での照合作業を大幅に削減（234ページを約5秒で構造化）
- セクション検出の自動化で目視確認の時間を削減
- 構造化データによる再利用性の向上

### 競合他社分析の高度化
- 複数企業の開示資料を効率的に比較
- トピック分析やトーン分析による深い洞察の獲得
- LLMによる文脈理解で微妙な表現の違いも検出

---

## 6. 開発ロードマップ

### 現在の位置（2025年11月時点）
✅ **フェーズ1完了**: 基本機能（アップロード、書類判定、構造化）  
✅ **フェーズ2完了**: 比較エンジン（セクションマッピング、差分分析、重要度判定）  
🚧 **フェーズ3進行中**: レポート表示機能の高度化  
📋 **フェーズ4計画中**: 品質・運用整備（E2Eテスト、CI/CD、ログ・メトリクス）

### 次のステップ
1. サイドバイサイドビューアの実装
2. 差分リスト・フィルタ機能の実装
3. レポートエクスポート機能（PDF/Excel）
4. E2Eテストとパフォーマンス最適化
5. 本番環境デプロイと運用監視

詳細な開発計画は `openspec/changes/add-disclosure-comparison-tool/` を参照してください。

---

