# セクション内容抽出の拡張仕様

## ADDED Requirements

### Requirement: KPI・財務指標の時系列データ抽出

システムは、各セクションから複数年度にわたるKPIおよび財務指標の時系列データを**原文に記載されているまま**構造化して抽出しなければならない（SHALL）。

**重要原則**:
- 自動計算や推測は一切行わない
- 原文に記載されている情報のみを抽出
- CAGR、トレンド、達成率等も原文に明記されている場合のみ抽出

#### Scenario: 5年分の財務指標推移の抽出

- **GIVEN** 「主要な経営指標等の推移」セクションに5年分の売上高、営業利益、ROE等の推移表が含まれる
- **WHEN** セクション内容抽出処理を実行する
- **THEN** 各指標について、5年分の時系列データが**原文に記載されているまま**構造化されて抽出される
- **AND** 原文にCAGR、トレンド、ボラティリティの**記載がある場合のみ**、その値が抽出される（自動計算は行わない）
- **AND** 目標値が記載されている場合は、**原文の表現のまま**目標値が抽出される（達成率の自動計算は行わない）

#### Scenario: セグメント別の時系列データ抽出

- **GIVEN** セグメント情報の注記に、セグメント別の売上高と営業利益の3年分の推移が記載されている
- **WHEN** セクション内容抽出処理を実行する
- **THEN** 各セグメントについて、時系列データが**原文に記載されているまま**構造化されて抽出される
- **AND** 原文にセグメント別のCAGRや売上構成比率の**記載がある場合のみ**、その値が抽出される（自動計算は行わない）

#### Scenario: 目標値と実績値の対応付け

- **GIVEN** 経営方針セクションに「ROE 10%以上を目指す」という目標が記載されている
- **AND** 主要な経営指標の推移に「ROE 9.8%」という実績が記載されている
- **WHEN** セクション内容抽出処理を実行する
- **THEN** ROEの時系列データに目標値（10.0%）と実績値（9.8%）が含まれる
- **AND** 達成率は**原文に明記されている場合のみ**抽出される（自動計算は行わない）

---

### Requirement: 論理関係の抽出

システムは、各セクションから因果関係、条件-結果、問題-解決、前提-結論などの論理関係を**原文に明記されているもののみ**構造化して抽出しなければならない（SHALL）。

**重要原則**:
- 原文に明確に記載されている論理関係のみを抽出
- 推測や解釈は行わない
- 必ず原文の該当箇所を引用（original_text）する

#### Scenario: 因果関係の抽出（売上増加の要因）

- **GIVEN** MD&Aセクションに「売上高が前年比10%増加したのは、新製品Aの販売が好調だったことと、海外市場での拡販が進んだことが主な要因です」と記載されている
- **WHEN** セクション内容抽出処理を実行する
- **THEN** 以下の因果関係が抽出される：
  ```json
  {
    "relationship_type": "causality",
    "subject": "売上高の前年比10%増加",
    "subject_category": "financial_result",
    "reason": "新製品Aの販売好調および海外市場での拡販",
    "reason_category": "business_driver",
    "evidence": "新製品Aの売上高が前年比150%、海外売上高が同120%",
    "original_text": "売上高が前年比10%増加したのは、新製品Aの販売が好調だったことと、海外市場での拡販が進んだことが主な要因です。",
    "confidence": "high"
  }
  ```
- **AND** `original_text`フィールドに原文の該当箇所が含まれる

#### Scenario: 問題-解決の関係抽出（リスクと対応策）

- **GIVEN** リスクセクションに「サイバーセキュリティリスクに対応するため、当社はCSIRT体制を構築し、多層防御を実施しています」と記載されている
- **WHEN** セクション内容抽出処理を実行する
- **THEN** 以下の問題-解決関係が抽出される：
  ```json
  {
    "relationship_type": "problem_solution",
    "problem": "サイバーセキュリティリスクの高まり",
    "problem_category": "risk",
    "solution": "CSIRT体制の構築と多層防御の実施",
    "solution_category": "mitigation_measure",
    "effectiveness": "リスクレベルを中程度に低減（原文に記載がある場合のみ）",
    "original_text": "サイバーセキュリティリスクに対応するため、当社はCSIRT体制を構築し、多層防御を実施しています。"
  }
  ```
- **AND** `original_text`フィールドに原文の該当箇所が含まれる

#### Scenario: 条件-結果の関係抽出（為替感応度）

- **GIVEN** MD&Aセクションに「為替相場が1ドル=140円を超える円安で推移した場合、営業利益が約30億円増加する見込みです」と記載されている
- **WHEN** セクション内容抽出処理を実行する
- **THEN** 以下の条件-結果関係が抽出される：
  ```json
  {
    "relationship_type": "condition_consequence",
    "condition": "為替相場が1ドル=140円を超える円安で推移",
    "condition_category": "external_factor",
    "consequence": "営業利益が約30億円増加する見込み",
    "consequence_category": "financial_impact",
    "original_text": "為替相場が1ドル=140円を超える円安で推移した場合、営業利益が約30億円増加する見込みです。",
    "confidence": "medium"
  }
  ```

#### Scenario: 前提-結論の関係抽出（経営方針と目標）

- **GIVEN** 経営方針セクションに「中長期的な企業価値向上を目指し、株主資本の効率的活用と持続的成長の両立を図るため、ROE 10%以上を目標としています」と記載されている
- **WHEN** セクション内容抽出処理を実行する
- **THEN** 以下の前提-結論関係が抽出される：
  ```json
  {
    "relationship_type": "premise_conclusion",
    "premise": "中長期的な企業価値向上を目指す",
    "premise_category": "management_policy",
    "conclusion": "ROE 10%以上を目標とする",
    "conclusion_category": "target_indicator",
    "reasoning": "株主資本の効率的活用と持続的成長の両立",
    "original_text": "中長期的な企業価値向上を目指し、株主資本の効率的活用と持続的成長の両立を図るため、ROE 10%以上を目標としています。"
  }
  ```

---

### Requirement: 抽出結果の検証

システムは、抽出された時系列データと論理関係の妥当性を検証しなければならない（SHALL）。

#### Scenario: 時系列データの整合性チェック

- **GIVEN** 抽出された時系列データに5年分の値が含まれる
- **WHEN** 検証処理を実行する
- **THEN** 各年度の値が数値型であることが確認される
- **AND** 年度の順序が正しいことが確認される
- **AND** 異常値（極端に大きい/小さい値）がログに警告として記録される

#### Scenario: 論理関係の信頼度評価

- **GIVEN** 抽出された因果関係に証拠（evidence）フィールドと原文引用（original_text）が含まれる
- **WHEN** 検証処理を実行する
- **THEN** 証拠と原文引用の有無に応じて信頼度（high/medium/low）が設定される
- **AND** 信頼度が"low"の場合は、手動確認が推奨される旨がログに記録される
- **AND** `original_text`が欠落している場合は警告が記録される

#### Scenario: 自動計算の防止チェック

- **GIVEN** 抽出された時系列データに`stated_metrics`フィールドが含まれる
- **WHEN** 検証処理を実行する
- **THEN** `stated_metrics`内のすべての値が原文から抽出されたものであることが確認される
- **AND** 自動計算された値が含まれていないことが確認される

---

## MODIFIED Requirements

### Requirement: セクション内容の構造化抽出

システムは、各セクションから以下の7種類の情報を構造化して抽出しなければならない（SHALL）：

1. **財務指標・数値情報** (financial_data) - 既存
2. **会計処理上のコメント** (accounting_notes) - 既存
3. **事実情報** (factual_info) - 既存
4. **主張・メッセージ** (messages) - 既存
5. **時系列財務データ** (kpi_time_series) - **新規追加**
6. **論理関係** (logical_relationships) - **新規追加**
7. **セグメント別時系列データ** (segment_time_series) - **新規追加**

**抽出の基本原則**:
- ✅ 要約禁止: 原文の表現をできるだけそのまま保持
- ✅ 推測禁止: 記載されていない情報を推測しない
- ✅ 計算禁止: 成長率、構成比、達成率等の自動計算は行わない
- ✅ 引用重視: 論理関係は必ず原文の該当箇所を引用

#### Scenario: 7種類の情報の抽出（拡張版）

- **GIVEN** 「事業の状況 - 経営成績の分析」セクションに、売上高の推移表、売上増加の要因説明、セグメント別の業績が含まれる
- **WHEN** セクション内容抽出処理を実行する
- **THEN** 以下の7種類の情報が構造化されて抽出される：
  1. `financial_data`: 当期の売上高、営業利益等の数値
  2. `accounting_notes`: 会計方針の変更に関する記載
  3. `factual_info`: 会社基本情報、組織情報
  4. `messages`: 経営方針、戦略に関するメッセージ
  5. `kpi_time_series`: 売上高、営業利益の5年分の推移データ（原文に記載されているまま）
  6. `logical_relationships`: 売上増加の要因（因果関係）と原文引用
  7. `segment_time_series`: セグメント別の売上高と営業利益の推移（原文に記載されているまま）
- **AND** すべての抽出データに自動計算や推測が含まれていない

#### Scenario: 空のセクションのハンドリング（変更なし）

- **GIVEN** 特定のセクションに抽出可能な情報が含まれない
- **WHEN** セクション内容抽出処理を実行する
- **THEN** 各カテゴリに空の配列 `[]` が返される
- **AND** エラーとはみなされず、処理が正常に完了する

