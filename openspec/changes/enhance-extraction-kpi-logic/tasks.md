# 実装タスク：KPI時系列と論理関係の追加

## 1. プロンプト設計とテスト

- [x] 1.1 時系列財務データ抽出のプロンプト設計
  - [x] 5年分のデータテーブルの検出パターンを定義
  - [x] 原文記載の指標（CAGR、トレンド等）の抽出パターンを定義
  - [x] 目標値と実績値の対応付けロジックを設計
  - [x] **自動計算を行わない**ことを明示

- [x] 1.2 論理関係抽出のプロンプト設計
  - [x] 因果関係（causality）の抽出パターンを定義
  - [x] 条件-結果（condition_consequence）の抽出パターンを定義
  - [x] 問題-解決（problem_solution）の抽出パターンを定義
  - [x] 前提-結論（premise_conclusion）の抽出パターンを定義
  - [x] 原文引用（original_text）を必須とする

- [x] 1.3 セグメント別時系列データ抽出のプロンプト設計
  - [x] セグメント情報とテーブルデータの紐づけロジックを設計
  - [x] セグメント別の時系列データ抽出パターンを定義
  - [x] 原文記載の構成比・成長率の抽出パターンを定義

- [ ] 1.4 サンプルデータでの抽出テスト
  - [ ] 有価証券報告書のサンプルで抽出精度を検証
  - [ ] 決算短信のサンプルで抽出精度を検証
  - [ ] **原文との一致度**を確認（要約や推測がないことを確認）
  - [ ] プロンプトの改善とイテレーション

## 2. 情報抽出の実装

- [x] 2.1 `section_content_extractor.py`の拡張
  - [x] `_build_extraction_prompt()`に新しいカテゴリを追加
  - [x] 時系列財務データの抽出ロジックを実装
  - [x] 論理関係の抽出ロジックを実装（original_text必須）
  - [x] セグメント別時系列データの抽出ロジックを実装
  - [x] 抽出結果の検証ロジックを追加

- [x] 2.2 原文記載の指標抽出
  - [x] 原文に記載されているCAGR、成長率を抽出（自動計算は行わない）
  - [x] 原文に記載されているトレンド表現を抽出（自動判定は行わない）
  - [x] 原文に記載されている目標達成率を抽出（自動計算は行わない）
  - [x] 原文のコメント・注記を忠実に抽出
  - [x] 原文引用（original_text）の抽出を実装

- [ ] 2.3 テーブルデータとの統合
  - [ ] テーブル抽出（`table_extractor.py`）との連携強化
  - [ ] 時系列データテーブルの自動識別ロジックを追加
  - [ ] テーブルヘッダーの年度認識ロジックを改善

## 3. データ構造の拡張

- [x] 3.1 スキーマ定義の追加
  - [x] `backend/app/schemas/documents.py`にKPI時系列のスキーマを追加（構造化データとしてdictで保存）
  - [x] `backend/app/schemas/comparisons.py`に論理関係のスキーマを追加（original_text必須）
  - [x] `backend/app/schemas/comparisons.py`に時系列比較結果のスキーマを追加

- [ ] 3.2 メタデータストアの拡張
  - [x] `metadata_store.py`で新しいフィールドをサポート（構造化データとして保存されるため自動対応）
  - [x] バージョン管理の実装（既存データとの互換性確保 - 空配列をデフォルトとして追加）

## 4. 比較処理の拡張

- [x] 4.1 時系列比較分析の実装（原文記載ベース）
  - [x] `comparison_engine.py`にKPI推移比較機能を追加
  - [x] 原文に記載されているトレンド表現の変化を検出
  - [x] 原文に記載されている目標値・実績値の比較機能を実装
  - [x] 原文に記載されている成長率の変化を検出
  - [x] 原文のコメントの変化を追跡

- [x] 4.2 論理関係の変化分析の実装
  - [x] 因果関係の追加・削除・変更を検出
  - [x] 問題-解決の対応関係の変化を追跡
  - [x] 経営方針と目標の記載内容の変化を検出
  - [x] 原文引用（original_text）の変化を追跡

- [x] 4.3 比較結果スキーマの拡張
  - [x] `backend/app/schemas/comparisons.py`に時系列比較結果を追加
  - [x] `backend/app/schemas/comparisons.py`に論理関係変化を追加

## 5. テストの追加

- [ ] 5.1 単体テストの追加
  - [ ] 時系列データ抽出のテストケースを作成
  - [ ] 論理関係抽出のテストケースを作成
  - [ ] 原文引用（original_text）の抽出テストを作成

- [ ] 5.2 統合テストの追加
  - [ ] 実際の有価証券報告書での抽出テスト
  - [ ] 年度間比較のテスト
  - [ ] エラーハンドリングのテスト

- [ ] 5.3 精度評価
  - [ ] 複数の実データでの抽出精度を測定
  - [ ] **原文との一致度**を確認（要約や推測がないことを確認）
  - [ ] **自動計算が行われていないことを確認**
  - [ ] プロンプトの改善
  - [ ] エッジケースの対応

## 6. ドキュメントの更新

- [ ] 6.1 テンプレートの更新
  - [ ] `backend/templates/securities_report.yaml`に抽出ポイントを追加
  - [ ] `backend/templates/earnings_report.yaml`に抽出ポイントを追加
  - [ ] `backend/templates/integrated_report.yaml`に抽出ポイントを追加

- [ ] 6.2 READMEの更新
  - [ ] `backend/templates/README.md`に新しい抽出項目を記載
  - [ ] 構造化データ形式のドキュメントを更新
  - [ ] **原文ベース抽出の原則**を明記

- [ ] 6.3 スペックの更新
  - [ ] `openspec/specs/document-structuring/spec.md`を更新
  - [ ] `openspec/specs/document-comparison/spec.md`を更新

## 7. パフォーマンス最適化

- [ ] 7.1 処理時間の測定
  - [ ] 新しい抽出処理の実行時間を測定
  - [ ] ボトルネックの特定

- [ ] 7.2 最適化の実装
  - [ ] 並列処理の調整（`max_workers`）
  - [ ] プロンプトの最適化（トークン数削減）
  - [ ] キャッシング機構の検討

## 8. デプロイと検証

- [ ] 8.1 ステージング環境でのテスト
  - [ ] 実データでの動作確認
  - [ ] APIレスポンスの検証
  - [ ] パフォーマンスの測定
  - [ ] 原文との一致度の確認

- [ ] 8.2 プロダクション環境へのデプロイ
  - [ ] データベースマイグレーション（必要に応じて）
  - [ ] デプロイ手順書の作成
  - [ ] ロールバック計画の準備

- [ ] 8.3 モニタリング
  - [ ] 抽出処理のエラー率を監視
  - [ ] LLM APIの使用量を監視
  - [ ] ユーザーフィードバックの収集

## 完了基準

- [ ] すべてのテストが成功
- [ ] 抽出精度が80%以上（手動評価）
- [ ] **原文との一致度が95%以上**（要約や推測がないことを確認）
- [ ] 処理時間が許容範囲内（1ドキュメント5分以内）
- [ ] ドキュメントがすべて更新済み
- [ ] プロダクション環境で正常動作

