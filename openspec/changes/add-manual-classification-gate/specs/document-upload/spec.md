## MODIFIED Requirements

### Requirement: 書類種別の自動判定
システムは、アップロードされたPDFファイルの書類種別（有価証券報告書、統合報告書、決算短信等）をLLMを用いて自動判定し、判定根拠を含めた結果をユーザーに提示しなければならない（MUST）。

#### Scenario: 有価証券報告書の自動判定と根拠表示
- **WHEN** ユーザーが有価証券報告書のPDFをアップロードする
- **THEN** システムはファイル名と冒頭20ページの内容をLLMで解析する
- **AND** 書類種別を「有価証券報告書」と判定する
- **AND** 判定結果と判定根拠（LLMの理由説明）をユーザーに表示する
- **AND** マッチキーワードは表示しない（内部ログのみで保持）

#### Scenario: 統合報告書の自動判定
- **WHEN** ユーザーが統合報告書のPDFをアップロードする
- **THEN** システムは書類種別を「統合報告書」と判定する
- **AND** 判定結果と判定根拠を表示する

#### Scenario: 判定不可能な書類
- **WHEN** ユーザーが判定不可能な書類（例: 一般的なプレゼン資料）をアップロードする
- **THEN** システムは「未判定」として扱う
- **AND** ユーザーに手動での種別選択を促すメッセージを表示する
- **AND** 構造化処理を開始しない

### Requirement: 書類種別の手動修正
システムは、自動判定された書類種別が誤っている場合、またはシステムが「未判定」と判定した場合に、ユーザーがプルダウンから手動で書類種別を選択できる機能を提供しなければならない（MUST）。手動選択後、システムは構造化処理を自動的に開始しなければならない（MUST）。

#### Scenario: 誤判定の修正
- **WHEN** システムが書類を「決算短信」と判定したが、実際は「統合報告書」である
- **AND** ユーザーが書類種別を「統合報告書」に手動で変更する
- **THEN** システムは修正後の書類種別を保存する
- **AND** 構造化処理を自動的に開始する
- **AND** 以降の処理で修正後の種別を使用する

#### Scenario: 判定不能な書類の手動設定と処理開始
- **WHEN** システムが書類種別を「未判定」と判定する
- **AND** ユーザーが書類種別リストから「有価証券報告書」を選択する
- **THEN** システムは選択された書類種別を保存する
- **AND** 構造化処理を自動的に開始する
- **AND** UIに処理開始の通知を表示する

## ADDED Requirements

### Requirement: 構造化処理のゲート制御
システムは、書類種別が「未判定（unknown）」または未選択の状態では構造化処理を開始してはならない（MUST NOT）。ユーザーが有効な書類種別を選択した時点で、構造化処理を開始しなければならない（MUST）。

#### Scenario: 未判定時の構造化処理スキップ
- **WHEN** ユーザーが書類をアップロードし、システムが「未判定」と判定する
- **THEN** システムは構造化処理をキューイングしない
- **AND** 書類のステータスを「分類待ち（pending_classification）」に設定する
- **AND** ユーザーに手動選択を促すメッセージを表示する

#### Scenario: 手動選択後の構造化処理開始
- **WHEN** ユーザーが「未判定」の書類に対して書類種別を手動で選択する
- **THEN** システムは選択された書類種別を保存する
- **AND** 構造化処理タスクをキューイングする
- **AND** 書類のステータスを「構造化処理中（processing）」に更新する

#### Scenario: 構造化処理中の書類種別変更
- **WHEN** すでに構造化処理が完了またはエラー状態の書類に対して、ユーザーが書類種別を変更する
- **THEN** システムは新しい書類種別で構造化処理を再実行する
- **AND** 以前の構造化結果を破棄し、新しい結果で上書きする

### Requirement: 判定根拠の提供
システムは、LLMによる書類種別の自動判定時に、判定の根拠（理由）をユーザーに提示しなければならない（MUST）。マッチキーワードはUI上で表示してはならない（MUST NOT）。

#### Scenario: LLM判定根拠の表示
- **WHEN** システムがLLMで書類を自動判定する
- **THEN** LLMから返された判定理由（reason）をメタデータとして保存する
- **AND** UIの書類詳細表示で判定根拠を確認できるようにする
- **AND** 判定根拠は「この書類は〇〇に該当すると判断しました。なぜなら…」のような形式で表示する

#### Scenario: マッチキーワードの非表示
- **WHEN** システムが書類種別を判定する
- **THEN** マッチキーワードは内部ログとして記録する
- **AND** UI上ではマッチキーワードを表示しない
- **AND** 判定根拠（LLMのreason）のみを表示する

