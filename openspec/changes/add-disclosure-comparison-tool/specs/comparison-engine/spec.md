## ADDED Requirements

### Requirement: 比較モードの自動判定
システムは、アップロードされた資料の組み合わせに基づいて、適切な比較モードを自動的に選択しなければならない（MUST）。

#### Scenario: 整合性チェックモードの起動
- **WHEN** 同じ会社の異なる種類の資料（例: A社の有価証券報告書とA社の統合報告書）がアップロードされる
- **THEN** システムは「整合性チェックモード」を選択する
- **AND** ユーザーに選択されたモードを通知する

#### Scenario: 差分分析モード（異なる会社）の起動
- **WHEN** 異なる会社の同じ種類の資料（例: A社の有価証券報告書とB社の有価証券報告書）がアップロードされる
- **THEN** システムは「差分分析モード」を選択する
- **AND** 比較対象として会社間比較を設定する

#### Scenario: 差分分析モード（過年度比較）の起動
- **WHEN** 同じ会社の同じ種類の異なる年度の資料（例: A社2024年有報とA社2025年有報）がアップロードされる
- **THEN** システムは「差分分析モード」を選択する
- **AND** 比較対象として年度間比較を設定する

#### Scenario: 多資料比較モードの起動
- **WHEN** 3つ以上の資料がアップロードされる
- **THEN** システムは「多資料比較モード」を選択する
- **AND** 全資料間での整合性と差異を網羅的にチェックする設定にする

### Requirement: 会社情報の自動抽出
システムは、各資料から会社名と年度情報を自動的に抽出しなければならない（MUST）。

#### Scenario: 有価証券報告書からの会社名と年度の抽出
- **WHEN** 有価証券報告書が処理される
- **THEN** システムはLLMを使用して表紙または冒頭ページから会社名を抽出する
- **AND** 対象年度（例: 2024年度）を抽出する
- **AND** 抽出された情報をユーザーに確認のため表示する

#### Scenario: 抽出失敗時の手動入力
- **WHEN** 会社名または年度情報の自動抽出が失敗する
- **THEN** システムはユーザーに手動入力を求める
- **AND** 入力フォームを表示する

### Requirement: 対応項目のマッピング
システムは、比較対象の資料間で対応する項目を自動的に紐付けなければならない（MUST）。

#### Scenario: 同じ書類種別間の項目マッピング
- **WHEN** 2つの有価証券報告書が比較される
- **THEN** システムは両方の資料の「事業等のリスク」項目を紐付ける
- **AND** 「MD&A」項目を紐付ける
- **AND** その他の標準項目を紐付ける

#### Scenario: 異なる書類種別間の項目マッピング
- **WHEN** 有価証券報告書と統合報告書が比較される
- **AND** 両方に「事業等のリスク」と類似する項目がある
- **THEN** システムはLLMを使用して意味的に対応する項目を紐付ける
- **AND** 信頼度スコアを表示する

#### Scenario: 対応項目が存在しない場合
- **WHEN** 一方の資料にのみ存在する項目がある
- **THEN** システムは「対応項目なし」としてマークする
- **AND** ユーザーに通知する

### Requirement: 数値データの比較
システムは、表中の数値データを比較し、不一致箇所を検出しなければならない（MUST）。

#### Scenario: 財務諸表の数値比較
- **WHEN** 2つの資料の財務諸表が比較される
- **THEN** システムは対応する数値（例: 売上高、営業利益）を比較する
- **AND** 数値が一致しない場合、差異を記録する
- **AND** 差異の金額と割合を計算する

#### Scenario: 丸め誤差の許容
- **WHEN** 2つの資料で同じ数値が異なる単位（千円 vs 百万円）で表示されている
- **THEN** システムは単位を統一して比較する
- **AND** 0.01%以内の差異は丸め誤差として許容する

#### Scenario: 数値の欠落検出
- **WHEN** 一方の資料に存在する数値が他方に存在しない
- **THEN** システムは「数値欠落」として記録する
- **AND** 該当箇所をハイライトする

### Requirement: テキストの完全一致/部分一致比較
システムは、テキストの完全一致および部分一致を検出しなければならない（MUST）。

#### Scenario: 完全一致の検出
- **WHEN** 2つの資料で同じ項目の文章が完全に一致する
- **THEN** システムは「完全一致」として記録する
- **AND** ユーザーに一致率100%として表示する

#### Scenario: 部分一致の検出
- **WHEN** 2つの資料で同じ項目の文章が部分的に異なる
- **THEN** システムはdifflibを使用して差異を検出する
- **AND** 追加された文、削除された文、変更された文を識別する
- **AND** 一致率（例: 85%）を計算する

#### Scenario: 表現の言い換え検出
- **WHEN** 実質的な内容は同じだが、表現が異なる文章がある
- **THEN** システムは次のステップの意味類似度分析に送る

### Requirement: 意味の類似度分析
システムは、表現が異なるが意味的に類似する内容を検出しなければならない（MUST）。

#### Scenario: 類似表現の検出
- **WHEN** 「サイバーセキュリティへの脅威」と「不正アクセスによる情報漏洩リスク」という2つの表現が比較される
- **THEN** システムはsentence-transformers（multilingual-e5-large）を使用して意味ベクトルを計算する
- **AND** コサイン類似度を計算する
- **AND** 類似度が0.75以上の場合、「意味的に類似」と判定する

#### Scenario: 意味が異なる内容の検出
- **WHEN** 2つの資料で同じ項目名だが内容が全く異なる
- **THEN** システムは類似度が低い（例: 0.3未満）ことを検出する
- **AND** 「重要な差異あり」として警告する

### Requirement: トピックの抽出と比較
システムは、各項目で語られている主要なトピックを抽出し、比較しなければならない（MUST）。

#### Scenario: リスク項目のトピック抽出
- **WHEN** 2つの資料の「事業等のリスク」項目が比較される
- **THEN** システムはLLMを使用して各資料から主要トピックを抽出する
- **AND** トピックの例: 「脱炭素」「DX」「人材育成」「サプライチェーン」「為替リスク」
- **AND** 各トピックの記述量（文字数または段落数）を計算する

#### Scenario: トピックの有無の比較
- **WHEN** 一方の資料にのみ特定のトピック（例: 「AI倫理」）が含まれている
- **THEN** システムは「片方のみに記載」として記録する
- **AND** ユーザーに通知する

#### Scenario: トピックの記述量の比較
- **WHEN** 両方の資料に「DX」というトピックが含まれている
- **AND** A社は500文字、B社は1200文字記述している
- **THEN** システムは記述量の差を計算する
- **AND** 「B社はA社の2.4倍の量を記述」と分析結果を表示する

### Requirement: ポジティブ/ネガティブ分析
システムは、リスク記述などのトーン（ポジティブ/ネガティブ）を分析しなければならない（MUST）。

#### Scenario: リスク記述のトーン分析
- **WHEN** 2つの資料の「事業等のリスク」項目が比較される
- **THEN** システムはLLMを使用して各記述のトーンを分析する
- **AND** ネガティブ度（1-5スケール）を計算する
- **AND** A社とB社のトーンの違いを定量化する

#### Scenario: 強い警告表現の検出
- **WHEN** 一方の資料が「重大な影響を及ぼす可能性が極めて高い」という強い表現を使用している
- **AND** 他方が「影響を及ぼす可能性がある」という弱い表現を使用している
- **THEN** システムは表現の強度の違いを検出する
- **AND** 「A社はより強い警告を発している」と分析結果を表示する

### Requirement: 整合性検証
システムは、同じ会社の異なる資料間での記述の整合性を検証しなければならない（MUST）。

#### Scenario: 数値の整合性チェック
- **WHEN** A社の有価証券報告書とA社の統合報告書が比較される
- **AND** 両方に「売上高」が記載されている
- **THEN** システムは数値が一致するかを検証する
- **AND** 不一致がある場合、警告を発する

#### Scenario: リスク記述の整合性チェック
- **WHEN** A社の有価証券報告書とA社の統合報告書が比較される
- **AND** 有報に記載されている重要なリスクが統合報告書に記載されていない
- **THEN** システムは「整合性の欠如」として記録する
- **AND** 該当箇所を指摘する

### Requirement: 比較結果の構造化
システムは、比較結果を構造化データとして保存しなければならない（MUST）。

#### Scenario: 比較結果の保存
- **WHEN** 比較処理が完了する
- **THEN** システムは以下の情報を構造化データとして保存する:
  - 比較モード
  - 対応項目のマッピング
  - 数値の差異リスト
  - テキストの差異リスト
  - 意味類似度スコア
  - トピック分析結果
  - トーン分析結果
  - 整合性検証結果

#### Scenario: 差異の優先度付け
- **WHEN** 複数の差異が検出される
- **THEN** システムは各差異に優先度（高/中/低）を付与する
- **AND** 優先度の基準: 重要項目の差異は「高」、軽微な表現の違いは「低」
- **AND** 優先度順にソートされた差異リストを生成する

### Requirement: カスタム比較設定
システムは、ユーザーが比較設定をカスタマイズできる機能を提供しなければならない（MUST）。

#### Scenario: 重視項目の設定
- **WHEN** ユーザーが「リスク情報」を重視する設定にする
- **THEN** システムは「事業等のリスク」項目の比較を特に詳細に行う
- **AND** リスク関連の差異を高優先度として扱う

#### Scenario: 軽微な差異の無視設定
- **WHEN** ユーザーが「句読点の違いは無視する」設定にする
- **THEN** システムは句読点のみが異なる差異を報告から除外する
- **AND** 設定を保存して次回以降も適用する


