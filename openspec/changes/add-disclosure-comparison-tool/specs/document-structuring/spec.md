## ADDED Requirements

### Requirement: PDFテキスト抽出
システムは、テキストベースのPDFファイルからテキストコンテンツを抽出しなければならない（MUST）。

#### Scenario: テキストベースPDFからのテキスト抽出
- **WHEN** ユーザーがテキストベースのPDFファイルをアップロードする
- **THEN** システムはPyMuPDFを使用してテキストを抽出する
- **AND** 抽出されたテキストを構造化データとして保存する

#### Scenario: 画像ベースPDFの検出と処理
- **WHEN** ユーザーが画像ベース（スキャン）のPDFファイルをアップロードする
- **AND** テキスト抽出が空または不十分である
- **THEN** システムは画像ベース処理に切り替える
- **AND** PDFをページごとに画像に変換する
- **AND** LLM Vision APIを使用してテキストを認識する

#### Scenario: ハイブリッドPDF（テキストと画像の混在）の処理
- **WHEN** PDFに通常のテキストページと画像ページが混在している
- **THEN** システムは各ページを個別に判定する
- **AND** テキストページはテキスト抽出、画像ページは画像処理を適用する

### Requirement: 表データの構造化抽出
システムは、PDFファイル内の表データを構造化形式で抽出しなければならない（MUST）。

#### Scenario: 財務諸表の表データ抽出
- **WHEN** PDFファイルに財務諸表の表が含まれている
- **THEN** システムはpdfplumberを使用して表を検出する
- **AND** 表のセル、行、列を構造化データとして抽出する
- **AND** 数値データを数値型として保存する

#### Scenario: 複雑なレイアウトの表の抽出
- **WHEN** 表が結合セルや複数レベルのヘッダーを持つ
- **THEN** システムは表の構造を可能な限り正確に抽出する
- **AND** 抽出精度が低い場合は警告を表示する

### Requirement: 書類テンプレートの定義
システムは、書類種別ごとに標準的な項目構成をテンプレートとして保持しなければならない（MUST）。

#### Scenario: 有価証券報告書テンプレートの適用
- **WHEN** アップロードされた書類が有価証券報告書と判定される
- **THEN** システムは有価証券報告書テンプレートを読み込む
- **AND** テンプレートには以下の標準項目が定義されている:
  - 企業の概況
  - 事業の状況
  - 事業等のリスク
  - 経営者による財政状態、経営成績及びキャッシュ・フローの状況の分析（MD&A）
  - 設備の状況
  - 提出会社の状況
  - 経理の状況

#### Scenario: カスタムテンプレートの使用
- **WHEN** ユーザーが特定の項目のみを抽出したい場合
- **THEN** システムはカスタムテンプレートの使用を許可する
- **AND** ユーザーが指定した項目のみを抽出対象とする

### Requirement: LLMによる項目マッピング
システムは、LLMを使用してPDFの各項目が何ページから何ページに記載されているかをマッピングしなければならない（MUST）。

#### Scenario: 有価証券報告書の項目マッピング
- **WHEN** 有価証券報告書のPDFが処理される
- **THEN** システムは10ページずつのバッチでLLMにページ画像を送信する
- **AND** 各バッチの処理時に直前のマッピング結果も文脈として渡す
- **AND** LLMは各項目の開始ページと終了ページを返す
- **AND** マッピング結果を構造化データとして保存する

#### Scenario: 項目の欠落検出
- **WHEN** テンプレートで定義された項目がPDF内に見つからない
- **THEN** システムは該当項目を「未検出」としてマークする
- **AND** ユーザーに通知する

#### Scenario: 非標準的な項目の検出
- **WHEN** PDFにテンプレートに定義されていない項目が含まれている
- **THEN** システムは追加項目として検出する
- **AND** 項目名とページ範囲をマッピング結果に追加する

### Requirement: マッピング精度の検証
システムは、LLMによるマッピング結果の精度を検証しなければならない（MUST）。

#### Scenario: 信頼度スコアの計算
- **WHEN** LLMが項目マッピングを実行する
- **THEN** システムは各マッピングに信頼度スコア（0-1）を付与する
- **AND** 信頼度が0.7未満の項目には警告を表示する

#### Scenario: 矛盾するマッピングの検出
- **WHEN** 複数の項目のページ範囲が重複している
- **THEN** システムは矛盾を検出する
- **AND** ユーザーに確認を求める

### Requirement: 構造化データの保存
システムは、抽出および構造化されたデータを保存しなければならない（MUST）。

#### Scenario: 構造化データの保存
- **WHEN** PDFの構造化処理が完了する
- **THEN** システムは以下のデータを保存する:
  - 書類メタデータ（ファイル名、種別、アップロード日時）
  - 全文テキスト
  - 項目マッピング情報（項目名、開始ページ、終了ページ）
  - 抽出された表データ
  - 構造化処理のログ

#### Scenario: セッション終了時のデータ削除
- **WHEN** ユーザーのセッションが終了する
- **THEN** システムはセッションに関連する全てのデータを削除する
- **AND** セキュリティのため、PDFファイル本体も削除する

### Requirement: 構造化処理の進捗表示
システムは、構造化処理の進捗状況をユーザーに表示しなければならない（MUST）。

#### Scenario: 構造化処理中の進捗表示
- **WHEN** システムがPDFの構造化処理を実行中である
- **THEN** 以下の情報を表示する:
  - 現在の処理ステップ（例: テキスト抽出中、項目マッピング中）
  - 処理済みページ数 / 総ページ数
  - 推定残り時間

#### Scenario: 複数ファイルの並列処理進捗
- **WHEN** 複数のPDFファイルが同時に構造化処理される
- **THEN** 各ファイルの個別進捗を表示する
- **AND** 全体の完了状況（例: 2/3ファイル完了）を表示する

### Requirement: エラーハンドリング
システムは、構造化処理中のエラーを適切に処理しなければならない（MUST）。

#### Scenario: LLM APIエラーのリトライ
- **WHEN** LLM APIへのリクエストが一時的なエラーで失敗する
- **THEN** システムは自動的にリトライする（最大3回）
- **AND** リトライ間隔は指数バックオフを使用する

#### Scenario: PDFの破損検出
- **WHEN** アップロードされたPDFファイルが破損している
- **THEN** システムはエラーを検出する
- **AND** ユーザーに「PDFファイルが破損しています」というエラーメッセージを表示する
- **AND** 処理を中止する


